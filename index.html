<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>KHADEME PRO | Secure</title>

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@200;400;600;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const logoSVG = encodeURIComponent(`<svg width="512" height="512" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="512" height="512" rx="128" fill="#050505"/><path d="M256 0L512 256L256 512L0 256L256 0Z" fill="url(#paint0_radial)" opacity="0.1"/><path d="M180 150V362M180 256H220M220 256L330 150M220 256L330 362" stroke="url(#goldGradient)" stroke-width="32" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="goldGradient" x1="180" y1="150" x2="330" y2="362" gradientUnits="userSpaceOnUse"><stop stop-color="#BF953F"/><stop offset="0.5" stop-color="#FCF6BA"/><stop offset="1" stop-color="#B38728"/></linearGradient><radialGradient id="paint0_radial" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(256 256) rotate(90) scale(256)"><stop stop-color="#D4AF37"/><stop offset="1" stop-color="#000000" stop-opacity="0"/></radialGradient></defs></svg>`);
        const link1 = document.createElement('link'); link1.rel = 'icon'; link1.href = `data:image/svg+xml,${logoSVG}`; document.head.appendChild(link1);
    </script>

    <style>
        :root {
            --bg-body: #050505;
            --bg-card: rgba(20, 20, 20, 0.85);
            --gold-primary: #D4AF37;
            --gold-light: #FCF6BA;
            --text-main: #FFFFFF;
            --text-sec: #999999;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --border-subtle: rgba(212, 175, 55, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 90px;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 60%);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Login Screen Styles */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px;
            background-image: radial-gradient(circle at 50% 0%, #222 0%, #000 80%);
        }
        .pin-display {
            font-size: 24px; letter-spacing: 5px; color: var(--gold-primary);
            margin-bottom: 30px; height: 30px;
        }
        .pin-pad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            max-width: 300px; width: 100%;
        }
        .pin-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle);
            color: #fff; font-size: 20px; height: 65px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .pin-btn:active { background: var(--gold-primary); color: #000; }
        .login-logo {
            font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 40px;
            background: linear-gradient(135deg, var(--gold-light), var(--gold-primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px;
        }

        /* Existing Styles */
        html[lang="en"] body { font-family: 'Inter', sans-serif; }
        html[lang="en"] .logo-text { font-family: 'Playfair Display', serif; }

        h1, h2, h3, h4 { font-weight: 600; }
        .logo-text {
            font-family: 'Playfair Display', serif; font-weight: 700; font-size: 20px;
            background: linear-gradient(135deg, var(--gold-light), var(--gold-primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px;
        }

        .app-container { max-width: 500px; margin: 0 auto; padding: 15px; position: relative; z-index: 2; opacity: 0; transition: opacity 0.5s; }
        .app-container.visible { opacity: 1; }

        header {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 0 20px;
            position: sticky; top: 0; z-index: 10; background: rgba(5,5,5,0.95); backdrop-filter: blur(10px);
        }

        .icon-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: var(--gold-primary);
            width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .lux-card {
            background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 20px;
            padding: 20px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;
        }

        .balance-slider {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scrollbar-width: none;
        }
        .balance-slider::-webkit-scrollbar { display: none; }
        
        .currency-card {
            min-width: 140px; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 15px; text-align: center;
            flex: 1; display: flex; flex-direction: column; justify-content: center;
        }
        .curr-label { font-size: 12px; color: var(--text-sec); margin-bottom: 5px; }
        .curr-amount { font-family: 'Inter', sans-serif; font-size: 18px; font-weight: 700; color: #fff; direction: ltr;}
        .curr-symbol { color: var(--gold-primary); font-size: 12px; }

        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 440px; height: 70px;
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle); border-radius: 25px;
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .nav-link { color: #666; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; transition: 0.3s; cursor: pointer; }
        .nav-link i { font-size: 18px; }
        .nav-link.active { color: var(--gold-primary); }
        .nav-link.active i { transform: translateY(-3px); }

        .btn-gold {
            width: 100%; background: linear-gradient(135deg, #b38728, #fcf6ba, #b38728); color: #000;
            border: none; padding: 14px; border-radius: 14px; font-weight: 700; cursor: pointer; margin-bottom: 10px;
        }
        .btn-outline {
            width: 100%; background: transparent; border: 1px solid var(--border-subtle); color: var(--gold-primary);
            padding: 12px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff;
            padding: 14px; border-radius: 12px; font-family: inherit; margin-bottom: 12px; outline: none;
        }
        input:focus { border-color: var(--gold-primary); }

        .tx-list { display: flex; flex-direction: column; gap: 10px; }
        .tx-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 15px; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid transparent;
            cursor: pointer; transition: 0.2s;
        }
        .tx-item:hover { background: rgba(255,255,255,0.06); }
        .tx-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-left: 12px; font-size: 16px; flex-shrink: 0; }
        html[lang="en"] .tx-icon { margin-left: 0; margin-right: 12px; }
        
        .tx-content { flex: 1; overflow: hidden; }
        .tx-content h4 { font-size: 14px; color: #fff; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tx-content p { font-size: 11px; color: #888; }
        .tx-amount { font-family: 'Inter', sans-serif; font-weight: 600; font-size: 14px; text-align: left; }
        html[lang="en"] .tx-amount { text-align: right; }
        
        .cat-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); margin-right: 5px; }
        html[lang="en"] .cat-badge { margin-right: 0; margin-left: 5px; }

        .hidden { display: none !important; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            body { background: white; color: black; padding: 0; }
            .app-container { max-width: 100%; margin: 0; padding: 0; }
            .bottom-nav, header, .no-print, #login-overlay { display: none !important; }
            .page { display: none !important; }
            #statement-page { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; color: black; padding: 20px; z-index: 9999; }
            .lux-card { border: none; box-shadow: none; background: white; padding: 0; margin: 0; color: black; }
            .statement-header { border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
            .statement-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
            .statement-table th { background: #eee; font-weight: bold; border: 1px solid #000; padding: 8px; text-align: center; color: black; }
            .statement-table td { border: 1px solid #000; padding: 8px; text-align: center; color: black; }
            h1, h2, h3, h4, span, div { color: black !important; text-shadow: none !important; }
        }
/* --- استایل‌های جدید و استاندارد برای صورت‌حساب --- */
.statement-paper {
    background: var(--bg-card); /* تغییر به رنگ پس‌زمینه کارت */
    color: var(--text-main);    /* تغییر به رنگ متن اصلی */
    padding: 0;
    border-radius: 4px;
    overflow: hidden;
}

/* جدول استاندارد حسابداری */
.std-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-top: 20px;
    direction: rtl;
}
.std-table th {
    background-color: rgba(255,255,255,0.05); /* تغییر هدر جدول به تیره */
    color: var(--gold-primary);
    font-weight: bold;
    padding: 10px;
    border: 1px solid #333;
    text-align: center;
}
.std-table td {
    padding: 8px;
    border: 1px solid #333; /* خطوط جدول تیره */
    text-align: center;
    color: #fff;
}
.std-table td.amount-col {
    direction: ltr;
    font-family: 'Inter', sans-serif;
    font-weight: 600;
}
.text-green { color: #2ecc71 !important; }
.text-red { color: #e74c3c !important; }

/* بخش هدر صورت‌حساب */
.invoice-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--gold-primary);
    padding-bottom: 15px;
    margin-bottom: 20px;
}
.invoice-info { text-align: right; }
.invoice-logo { font-family: 'Playfair Display'; font-size: 24px; color: var(--gold-primary); font-weight: bold; }

/* نمایش در موبایل (کارت‌ها) */
.mobile-statement-list { display: block; }
.desktop-print-view { display: none; }

@media print {
    body { background: white !important; padding: 0; margin: 0; color: black !important; }
    .app-container { max-width: 100%; margin: 0; padding: 0; opacity: 1; }
    .no-print, .bottom-nav, header, #login-overlay { display: none !important; }
    
    .page { display: none !important; }
    #statement-page { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 9999; padding: 10mm; background: white !important; }
    
    .statement-paper { background: white !important; color: black !important; border: none; }
    .lux-card { box-shadow: none; border: none; padding: 0; margin: 0; background: #fff !important; }
    
    .std-table th { background-color: #eee !important; color: #000 !important; border: 1px solid #000 !important; }
    .std-table td { border: 1px solid #000 !important; color: #000 !important; }
    
    .invoice-logo { color: #000 !important; }
    
    /* مخفی کردن نمای موبایل و نمایش جدول رسمی در پرینت */
    .mobile-statement-list { display: none; }
    .desktop-print-view { display: block; width: 100%; }
    
    h1, h2, h3, h4, span, div, p { color: #000 !important; text-shadow: none !important; }
    .btn-outline, .btn-gold { display: none; }
}
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-logo">KHADEME</div>
        <div id="login-msg" style="color:#888; margin-bottom:20px; font-size:14px;">لطفا رمز عبور را وارد کنید</div>
        <div class="pin-display" id="pin-dots"></div>
        <div class="pin-pad">
            <div class="pin-btn" onclick="pressPin(1)">1</div>
            <div class="pin-btn" onclick="pressPin(2)">2</div>
            <div class="pin-btn" onclick="pressPin(3)">3</div>
            <div class="pin-btn" onclick="pressPin(4)">4</div>
            <div class="pin-btn" onclick="pressPin(5)">5</div>
            <div class="pin-btn" onclick="pressPin(6)">6</div>
            <div class="pin-btn" onclick="pressPin(7)">7</div>
            <div class="pin-btn" onclick="pressPin(8)">8</div>
            <div class="pin-btn" onclick="pressPin(9)">9</div>
            <div class="pin-btn" style="border:none;"></div>
            <div class="pin-btn" onclick="pressPin(0)">0</div>
            <div class="pin-btn" style="border:none; color:var(--accent-red)" onclick="clearPin()"><i class="fas fa-backspace"></i></div>
        </div>
<div id="forgot-btn" onclick="forgotPin()" style="margin-top: 20px; color: #666; font-size: 12px; cursor: pointer; text-decoration: underline;">
    رمز را فراموش کرده‌ام (بازیابی)
</div>
    </div>

    <div class="app-container" id="main-app">
        
        <header>
            <div class="icon-btn" onclick="toggleLang()"><i class="fas fa-globe"></i></div>
            <div class="logo-text">KHADEME</div>
            <div class="icon-btn" onclick="navigate('settings')"><i class="fas fa-cog"></i></div>
        </header>

        <div id="home-page" class="page active">
            <div class="lux-card">
                <div data-lang="wallet_bal" style="font-size: 12px; color: #888; margin-bottom: 10px; text-align:center;">موجودی کیف پول‌ها</div>
                <div class="balance-slider" id="balance-container"></div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-gold" style="flex:1" onclick="openTxModal('income')">
                    <i class="fas fa-plus"></i> <span data-lang="receive">دریافت</span>
                </button>
                <button class="btn-outline" style="flex:1; border-color: rgba(231, 76, 60, 0.4); color: var(--accent-red);" onclick="openTxModal('expense')">
                    <i class="fas fa-minus"></i> <span data-lang="pay">پرداخت</span>
                </button>
            </div>

            <h3 data-lang="recent_tx" style="margin-bottom: 15px; font-size: 16px; color: var(--gold-primary);">تراکنش‌های اخیر</h3>
            <div class="tx-list" id="recent-transactions"></div>
        </div>

        <div id="transactions-page" class="page">
            <div class="lux-card">
                <h2 data-lang="journal" style="margin-bottom: 15px; color: var(--gold-primary);">دفتر روزنامه</h2>
                <input type="text" id="search-tx" data-ph="search_ph" placeholder="جستجو..." onkeyup="renderTransactionsPage()">
            </div>
            <div class="tx-list" id="all-transactions"></div>
        </div>

        <div id="customers-page" class="page">
            <div class="lux-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 data-lang="customers" style="color: var(--gold-primary);">اشخاص و طرف‌حساب</h2>
                    <button class="icon-btn" onclick="document.getElementById('add-customer-area').classList.toggle('hidden')"><i class="fas fa-plus"></i></button>
                </div>
                
                <div id="add-customer-area" class="hidden" style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                    <input type="text" id="new-cust-name" data-ph="name_ph" placeholder="نام طرف حساب">
                    <select id="new-cust-type">
                        <option value="business" data-lang="type_biz">مشتری / تجاری</option>
                        <option value="family" data-lang="type_fam">خانواده / مخارج شخصی</option>
                    </select>
                    <input type="tel" id="new-cust-phone" data-ph="phone_ph" placeholder="شماره تماس (اختیاری)">
                    <button class="btn-gold" data-lang="add_btn" onclick="addCustomer()">افزودن شخص</button>
                </div>

                <div data-lang="cust_hint" style="margin-bottom: 10px; font-size: 12px; color: #666;">برای مشاهده صورت‌حساب روی نام شخص کلیک کنید.</div>
                <div class="tx-list" id="customers-list"></div>
            </div>
        </div>
<div id="statement-page" class="page">
    <div class="lux-card statement-paper">
        <div class="no-print" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button class="btn-outline" onclick="navigate('customers')" style="width: auto;">
                <i class="fas fa-arrow-right"></i> <span data-lang="back">بازگشت</span>
            </button>
            <button class="btn-gold" onclick="window.print()" style="width: auto; flex:1;">
                <i class="fas fa-print"></i> <span data-lang="print">چاپ / PDF استاندارد</span>
            </button>
        </div>

        <div class="invoice-header">
            <div class="invoice-info">
                <h2 id="stmt-name" style="color:var(--gold-primary); margin-bottom:5px;">---</h2>
                <p id="stmt-phone" style="color: #666; font-size: 13px;">---</p>
            </div>
            <div style="text-align: left;">
                <div class="invoice-logo">KHADEME</div>
                <div id="stmt-date" style="color: #666; font-size: 11px; margin-top: 5px;">---</div>
            </div>
        </div>

        <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
    <h4 style="color:#aaa; margin-bottom:10px; font-size:12px; border-bottom:1px solid #333; padding-bottom:5px;">خلاصه وضعیت (تراز نهایی)</h4>
            <h4 style="color:#444; margin-bottom:10px; font-size:12px; border-bottom:1px solid #ddd; padding-bottom:5px;">خلاصه وضعیت (تراز نهایی)</h4>
            <div id="stmt-summary" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;"></div>
        </div>

        <div class="mobile-statement-list tx-list no-print" id="stmt-tx-list"></div>

        <div class="desktop-print-view">
            <table class="std-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">تاریخ</th>
                        <th>شرح / بابت</th>
                        <th style="width: 10%;">ارز</th>
                        <th style="width: 15%; color:#2ecc71;">دریافت (بدهکار)</th>
                        <th style="width: 15%; color:#e74c3c;">پرداخت (بستانکار)</th>
                    </tr>
                </thead>
                <tbody id="stmt-table-body">
                    </tbody>
            </table>
            
            <div style="margin-top: 30px; border-top: 1px solid #000; padding-top: 10px; display:flex; justify-content:space-between;">
                <div style="font-size:10px; text-align:center;">امضاء حسابدار</div>
                <div style="font-size:10px; text-align:center;">امضاء طرف حساب</div>
            </div>
        </div>
    </div>
</div>

        <div id="reports-page" class="page">
            <div class="lux-card">
                <h2 data-lang="reports_title" style="margin-bottom: 20px; color: var(--gold-primary);">گزارشات تفکیکی</h2>
                
                <select id="report-filter-type" onchange="renderReportsPage()" style="margin-bottom: 10px;">
                    <option value="all" data-lang="rep_all">همه حساب‌ها (مخلوط)</option>
                    <option value="business" data-lang="rep_biz">فقط مشتریان (کسب و کار)</option>
                    <option value="family" data-lang="rep_fam">فقط خانواده / شخصی</option>
                </select>

                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 data-lang="perf_sum" style="font-size:13px; color:#aaa; margin-bottom:10px;">خلاصه عملکرد انتخابی</h4>
                    <div id="report-summary-text"></div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 data-lang="by_country" style="color: var(--gold-primary); font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom:5px;">تفکیک بر اساس کشور</h4>
                    <div id="country-report-list" class="tx-list"></div>
                </div>
            </div>
        </div>

       <div id="settings-page" class="page">
    <div class="lux-card">
        <h2 data-lang="settings" style="margin-bottom: 20px; color: var(--gold-primary);">تنظیمات</h2>
        
        <div style="margin-bottom:20px; padding:15px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; background:rgba(255,255,255,0.03);">
            <div style="color:#888; font-size:12px; margin-bottom:10px;">امنیت و ورود</div>
            <button class="btn-outline" onclick="changePin()" style="font-size:13px; border-color: #666; color: #ccc;">
                <i class="fas fa-key"></i> تغییر رمز عبور
            </button>
        </div>

        <div style="margin-bottom:20px;">
            <div style="color:var(--gold-primary); font-size:12px; margin-bottom:10px;">پشتیبان‌گیری و جابجایی اطلاعات</div>
            
            <button class="btn-outline" onclick="downloadBackup()" style="margin-bottom: 10px; color: var(--accent-green); border-color: var(--accent-green);">
                <i class="fas fa-file-export"></i> <span data-lang="backup">دانلود فایل پشتیبان (Save)</span>
            </button>

            <button class="btn-outline" onclick="triggerRestore()" style="margin-bottom: 10px; color: var(--gold-primary); border-color: var(--gold-primary);">
                <i class="fas fa-file-import"></i> <span data-lang="restore">بازگردانی فایل (Restore)</span>
            </button>
            
            <input type="file" id="restore-input" style="display: none;" onchange="restoreBackup(event)" accept=".json">
        </div>

        <button class="btn-outline" onclick="hardReset()" style="color: var(--accent-red); border-color: var(--accent-red); margin-top: 20px;">
            <i class="fas fa-trash-alt"></i> <span data-lang="delete_all">حذف کامل داده‌ها و ریست</span>
        </button>
        
        <p style="text-align: center; color: #444; font-size: 10px; margin-top: 10px;">KHADEME PRO v5.1 | Offline Mode</p>
    </div>
</div>

    </div>
<div id="tx-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; padding: 20px; align-items: center; justify-content: center; display: flex;">
    <div class="lux-card" style="width: 100%; max-width: 400px; animation: fadeIn 0.3s;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
            <h3 id="modal-title">ثبت جدید</h3>
            <i class="fas fa-times" onclick="document.getElementById('tx-modal').classList.add('hidden')" style="padding: 10px; cursor: pointer;"></i>
        </div>
        
        <div style="margin-bottom: 12px;">
            <label style="font-size: 10px; color: #888; margin-bottom: 5px; display: block;">تاریخ تراکنش:</label>
            <input type="date" id="tx-date" style="margin-bottom: 0;">
        </div>

        <select id="tx-currency" style="margin-bottom: 12px;">
            <option value="AED">AED (درهم)</option>
            <option value="USD">USD (دلار)</option>
            <option value="TRY">TRY (لیر)</option>
            <option value="AFN">AFN (افغانی)</option>
            <option value="IRR">IRR (تومان/ریال)</option>
            <option value="EUR">EUR (یورو)</option>
        </select>

        <input type="number" id="tx-amount" step="0.01" data-ph="amt_ph" placeholder="مبلغ">
        <select id="tx-customer-select"></select>
        <textarea id="tx-desc" rows="2" data-ph="desc_ph" placeholder="توضیحات..."></textarea>
        <button id="save-tx-btn" class="btn-gold" onclick="saveTransaction()">ثبت نهایی</button>
    </div>
</div>
    <nav class="bottom-nav">
        <div class="nav-link active" onclick="navigate('home', this)"><i class="fas fa-wallet"></i><span data-lang="nav_wallet">کیف‌پول</span></div>
        <div class="nav-link" onclick="navigate('transactions', this)"><i class="fas fa-list"></i><span data-lang="nav_tx">تراکنش</span></div>
        <div class="nav-link" onclick="navigate('customers', this)"><i class="fas fa-users"></i><span data-lang="nav_ppl">اشخاص</span></div>
        <div class="nav-link" onclick="navigate('reports', this)"><i class="fas fa-chart-pie"></i><span data-lang="nav_rep">گزارش</span></div>
    </nav>

    <script>

// --- AUTH SYSTEM (UPDATED) ---
        let currentPin = '';
        let savedPin = localStorage.getItem('khademe_pin');
        let recoveryCode = localStorage.getItem('khademe_recovery'); // کد بازیابی
        let isSettingPin = !savedPin;

        window.onload = () => {
            // Setup Firebase
            try { if(typeof firebase !== 'undefined') firebase.initializeApp(firebaseConfig); } catch(e){}
            
            // Check Auth
            initAuth();
        };

        function initAuth() {
            const msg = document.getElementById('login-msg');
            const forgotBtn = document.getElementById('forgot-btn');

            if(isSettingPin) {
                msg.innerText = "یک رمز عبور ۴ رقمی جدید تعیین کنید";
                msg.style.color = "var(--gold-primary)";
                if(forgotBtn) forgotBtn.style.display = 'none'; // مخفی کردن دکمه فراموشی هنگام ثبت نام
            } else {
                msg.innerText = "لطفا رمز عبور را وارد کنید";
                msg.style.color = "#888";
                if(forgotBtn) forgotBtn.style.display = 'block';
            }
        }

        function pressPin(num) {
            if(currentPin.length < 4) {
                currentPin += num;
                updatePinDisplay();
                if(currentPin.length === 4) checkPin();
            }
        }

        function clearPin() {
            currentPin = '';
            updatePinDisplay();
        }

        function updatePinDisplay() {
            const dots = document.getElementById('pin-dots');
            dots.innerHTML = '* '.repeat(currentPin.length);
        }

        function checkPin() {
            setTimeout(() => {
                if(isSettingPin) {
                    // --- تایید رمز جدید و ساخت کد بازیابی ---
                    if(!confirm('رمز انتخاب شده: ' + currentPin + '\nآیا مطمئن هستید؟')) {
                        clearPin();
                        return;
                    }

                    // تولید کد بازیابی ۸ رقمی تصادفی
                    const newRecoveryCode = Math.floor(10000000 + Math.random() * 90000000);
                    
                    alert(`⚠️ کد بازیابی شما: ${newRecoveryCode}\n\nلطفا این کد را یادداشت کنید. اگر رمز را فراموش کنید، تنها راه بازگشت اطلاعات این کد است.`);
                    
                    localStorage.setItem('khademe_pin', currentPin);
                    localStorage.setItem('khademe_recovery', newRecoveryCode);
                    
                    savedPin = currentPin;
                    recoveryCode = newRecoveryCode;
                    isSettingPin = false;
                    unlockApp();

                } else {
                    // --- ورود عادی ---
                    if(currentPin === savedPin) {
                        unlockApp();
                    } else {
                        const msg = document.getElementById('login-msg');
                        msg.innerText = "رمز اشتباه است!";
                        msg.style.color = "var(--accent-red)";
                        setTimeout(() => {
                            clearPin();
                            msg.innerText = "لطفا رمز عبور را وارد کنید";
                            msg.style.color = "#888";
                        }, 1000);
                    }
                }
            }, 100);
        }

        function forgotPin() {
            const inputCode = prompt("لطفا کد بازیابی ۸ رقمی (Recovery Code) خود را وارد کنید:");
            if (inputCode === null) return; 

            if (inputCode == recoveryCode) {
                alert("کد صحیح بود. لطفا رمز جدید تعیین کنید.");
                localStorage.removeItem('khademe_pin');
                location.reload(); 
            } else {
                alert("کد بازیابی اشتباه است.");
            }
        }

        function unlockApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').classList.add('visible');
            loadData();
            updateUI();
        }

        function changePin() {
            if(confirm('آیا می‌خواهید رمز جدید تعیین کنید؟ (کد بازیابی هم تغییر می‌کند)')) {
                localStorage.removeItem('khademe_pin');
                location.reload();
            }
        }

        // --- TRANSLATION DATA ---
        let currentLang = 'fa';
        
        const lang = {
            fa: {
                wallet_bal: "موجودی کیف پول‌ها",
                receive: "دریافت",
                pay: "پرداخت",
                recent_tx: "تراکنش‌های اخیر",
                journal: "دفتر روزنامه",
                search_ph: "جستجو...",
                customers: "اشخاص و طرف‌حساب",
                name_ph: "نام طرف حساب",
                type_biz: "مشتری / تجاری",
                type_fam: "خانواده / مخارج شخصی",
                phone_ph: "شماره تماس (اختیاری)",
                add_btn: "افزودن شخص",
                cust_hint: "برای مشاهده صورت‌حساب روی نام شخص کلیک کنید.",
                back: "بازگشت",
                print: "چاپ صورت‌حساب",
                date: "تاریخ",
                desc: "توضیحات",
                country_curr: "کشور/ارز",
                type: "نوع",
                amount: "مبلغ",
                reports_title: "گزارشات تفکیکی",
                rep_all: "همه حساب‌ها (مخلوط)",
                rep_biz: "فقط مشتریان (کسب و کار)",
                rep_fam: "فقط خانواده / شخصی",
                perf_sum: "خلاصه عملکرد انتخابی",
                by_country: "تفکیک بر اساس کشور",
                settings: "تنظیمات",
                backup: "پشتیبان‌گیری ابری",
                restore: "بازیابی اطلاعات",
                delete_all: "حذف کامل داده‌ها",
                save_btn: "ثبت نهایی",
                amt_ph: "مبلغ",
                desc_ph: "توضیحات...",
                nav_wallet: "کیف‌پول",
                nav_tx: "تراکنش",
                nav_ppl: "اشخاص",
                nav_rep: "گزارش",
                unknown: "ناشناس",
                inc_new: "دریافت جدید",
                exp_new: "پرداخت جدید",
                choose: "انتخاب کنید...",
                alert_input: "لطفا مبلغ و شخص را مشخص کنید",
                confirm_del: "آیا مطمئن هستید؟",
                income: "دریافت",
                expense: "پرداخت",
                balance: "تراز",
                no_data: "داده‌ای موجود نیست"
            },
            en: {
                wallet_bal: "Wallet Balances",
                receive: "Income",
                pay: "Expense",
                recent_tx: "Recent Transactions",
                journal: "Journal",
                search_ph: "Search...",
                customers: "Contacts & People",
                name_ph: "Contact Name",
                type_biz: "Business / Client",
                type_fam: "Family / Personal",
                phone_ph: "Phone Number (Optional)",
                add_btn: "Add Contact",
                cust_hint: "Click on a name to view statement.",
                back: "Back",
                print: "Print Statement",
                date: "Date",
                desc: "Description",
                country_curr: "Country/Currency",
                type: "Type",
                amount: "Amount",
                reports_title: "Detailed Reports",
                rep_all: "All Accounts (Mixed)",
                rep_biz: "Business Only",
                rep_fam: "Family / Personal",
                perf_sum: "Performance Summary",
                by_country: "By Country",
                settings: "Settings",
                backup: "Cloud Backup",
                restore: "Restore Data",
                delete_all: "Delete All Data",
                save_btn: "Save Transaction",
                amt_ph: "Amount",
                desc_ph: "Description...",
                nav_wallet: "Wallet",
                nav_tx: "Transact",
                nav_ppl: "People",
                nav_rep: "Reports",
                unknown: "Unknown",
                inc_new: "New Income",
                exp_new: "New Expense",
                choose: "Select...",
                alert_input: "Please enter amount and person",
                confirm_del: "Are you sure?",
                income: "Income",
                expense: "Expense",
                balance: "Balance",
                no_data: "No data available"
            }
        };

        // --- CONFIG ---
        const firebaseConfig = { apiKey: "YOUR_API_KEY", projectId: "YOUR_ID" };
        
        // --- DATA ---
        let data = { transactions: [], customers: [], settings: {} };
        let editingTxId = null; 
        const CURRENCY_SYMBOLS = { 'USD': '$', 'EUR': '€', 'AED': 'د.إ', 'TRY': '₺', 'AFN': '؋', 'IRR': 'ت' };

        // Main logic moved to unlockApp() for security

        // --- LANGUAGE HANDLER ---
        function toggleLang() {
            currentLang = currentLang === 'fa' ? 'en' : 'fa';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'fa' ? 'rtl' : 'ltr';
            updateTranslations();
            updateUI(); // Refresh dynamic content
            renderCustomersPage(); // Refresh specific lists
        }

        function updateTranslations() {
            // Update Text Content
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if(lang[currentLang][key]) el.innerText = lang[currentLang][key];
            });
            // Update Placeholders
            document.querySelectorAll('[data-ph]').forEach(el => {
                const key = el.getAttribute('data-ph');
                if(lang[currentLang][key]) el.placeholder = lang[currentLang][key];
            });
        }

        function loadData() {
            const saved = localStorage.getItem('khademe_pro_v5');
            if (saved) data = JSON.parse(saved);
        }

        function saveData() {
            localStorage.setItem('khademe_pro_v5', JSON.stringify(data));
            updateUI();
        }

        function navigate(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            if(pageId === 'home') updateUI();
            if(pageId === 'transactions') renderTransactionsPage();
            if(pageId === 'customers') renderCustomersPage();
            if(pageId === 'reports') renderReportsPage();
        }

        function formatMoney(amount) {
            return parseFloat(amount).toLocaleString();
        }

        // --- CORE UI UPDATES ---
        function updateUI() {
            const balances = {};
            data.transactions.forEach(t => {
                if(!balances[t.currency]) balances[t.currency] = 0;
                if(t.type === 'income') balances[t.currency] += parseFloat(t.amount);
                else balances[t.currency] -= parseFloat(t.amount);
            });

            const balContainer = document.getElementById('balance-container');
            balContainer.innerHTML = '';
            
            if(Object.keys(balances).length === 0) {
                balContainer.innerHTML = `<div class="currency-card"><span style="font-size:12px; color:#888;">${lang[currentLang].no_data}</span></div>`;
            } else {
                for(const [curr, amt] of Object.entries(balances)) {
                    if(amt === 0) continue;
                    balContainer.innerHTML += `
                        <div class="currency-card">
                            <div class="curr-label">${curr}</div>
                            <div class="curr-amount" style="color: ${amt >= 0 ? '#fff' : '#e74c3c'}">
                                ${formatMoney(amt)} <span class="curr-symbol">${CURRENCY_SYMBOLS[curr] || ''}</span>
                            </div>
                        </div>
                    `;
                }
            }

            const recentList = document.getElementById('recent-transactions');
            recentList.innerHTML = '';
            const recent = [...data.transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            recent.forEach(tx => recentList.innerHTML += createTxHTML(tx));

            const sel = document.getElementById('tx-customer-select');
            sel.innerHTML = `<option value="" disabled selected>${lang[currentLang].choose}</option>`;
            data.customers.forEach(c => {
                const typeLabel = c.type === 'family' ? (currentLang==='fa'?'خانواده':'Family') : (currentLang==='fa'?'مشتری':'Business');
                sel.innerHTML += `<option value="${c.id}">${c.name} (${typeLabel})</option>`;
            });
        }

        function createTxHTML(tx) {
    const customer = data.customers.find(c => c.id == tx.customerId) || { name: lang[currentLang].unknown };
    const isInc = tx.type === 'income';
    
    // فرمت کردن تاریخ برای نمایش
    const dateObj = new Date(tx.date);
    const dateStr = dateObj.toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US');

    return `
        <div class="tx-item" style="flex-wrap: wrap;">
            <div style="display:flex; align-items:center; flex:1; min-width: 60%;">
                <div class="tx-icon" style="background: ${isInc ? 'rgba(46, 204, 113, 0.15)' : 'rgba(231, 76, 60, 0.15)'}; color: ${isInc ? '#2ecc71' : '#e74c3c'}">
                    <i class="fas ${isInc ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                </div>
                <div class="tx-content">
                    <h4>${customer.name}</h4>
                    <p style="font-size:10px; color:#888;">${dateStr} | ${tx.desc || ''}</p>
                </div>
            </div>
            <div style="text-align:${currentLang==='fa'?'left':'right'}; display:flex; flex-direction:column; align-items:flex-end;">
                <div class="tx-amount" style="color: ${isInc ? '#2ecc71' : '#e74c3c'}; margin-bottom:5px;">
                    ${formatMoney(tx.amount)} ${tx.currency}
                </div>
                <div style="display:flex; gap:10px;">
                    <i class="fas fa-pen" onclick="editTx(${tx.id})" style="color:#d4af37; font-size:14px; cursor:pointer; padding:5px;"></i>
                    <i class="fas fa-trash" onclick="deleteTx(${tx.id})" style="color:#e74c3c; font-size:14px; cursor:pointer; padding:5px;"></i>
                </div>
            </div>
        </div>
    `;
}
function openTxModal(type) {
    editingTxId = null; // حالت ثبت جدید
    currentTxType = type;
    
    document.getElementById('modal-title').innerText = type === 'income' ? lang[currentLang].inc_new : lang[currentLang].exp_new;
    document.getElementById('save-tx-btn').innerText = lang[currentLang].save_btn || "ثبت نهایی";

    // تنظیم تاریخ امروز
    const now = new Date();
    const dateString = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
    document.getElementById('tx-date').value = dateString;

    // خالی کردن فیلدها
    document.getElementById('tx-amount').value = '';
    document.getElementById('tx-desc').value = '';
    document.getElementById('tx-customer-select').value = '';

    document.getElementById('tx-modal').classList.remove('hidden');
}
function saveTransaction() {
    const amount = parseFloat(document.getElementById('tx-amount').value);
    const custId = document.getElementById('tx-customer-select').value;
    const dateInput = document.getElementById('tx-date').value;
    const currency = document.getElementById('tx-currency').value;
    const desc = document.getElementById('tx-desc').value;

    if(!amount || !custId || !dateInput) return alert(lang[currentLang].alert_input);

    if (editingTxId) {
        // --- ویرایش تراکنش موجود ---
        const index = data.transactions.findIndex(t => t.id === editingTxId);
        if (index !== -1) {
            data.transactions[index].amount = amount;
            data.transactions[index].currency = currency;
            data.transactions[index].customerId = custId;
            data.transactions[index].desc = desc;
            data.transactions[index].date = new Date(dateInput).toISOString();
            // data.transactions[index].type = currentTxType; // اگر مایلید نوع تراکنش هم قابل تغییر باشد این خط را فعال کنید
        }
    } else {
        // --- ثبت تراکنش جدید ---
        const tx = {
            id: Date.now(),
            type: currentTxType,
            amount: amount,
            currency: currency,
            customerId: custId,
            desc: desc,
            date: new Date(dateInput).toISOString()
        };
        data.transactions.push(tx);
    }

    // مرتب‌سازی مجدد بر اساس تاریخ (بسیار مهم)
    data.transactions.sort((a,b) => new Date(b.date) - new Date(a.date));

    saveData();
    document.getElementById('tx-modal').classList.add('hidden');
    
    // بروزرسانی تمام صفحات
    updateUI(); 
    if(document.getElementById('transactions-page').classList.contains('active')) {
        renderTransactionsPage();
    }
    // اگر در صفحه صورت‌حساب شخص هستید، رفرش شود
    const activePage = document.querySelector('.page.active');
    if (activePage.id === 'statement-page') {
        const stmtName = document.getElementById('stmt-name').innerText;
        const cust = data.customers.find(c => c.name === stmtName);
        if(cust) openCustomerStatement(cust.id);
    }
}
        function deleteTx(id) {
            if(confirm(lang[currentLang].confirm_del)) {
                data.transactions = data.transactions.filter(t => t.id !== id);
                saveData();
                renderTransactionsPage();
            }
        }

        function renderTransactionsPage() {
            const term = document.getElementById('search-tx').value.toLowerCase();
            const list = document.getElementById('all-transactions');
            list.innerHTML = '';
            const filtered = data.transactions.filter(t => {
                const cName = (data.customers.find(c => c.id == t.customerId)?.name || '').toLowerCase();
                return cName.includes(term) || (t.desc && t.desc.toLowerCase().includes(term));
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            filtered.forEach(tx => list.innerHTML += createTxHTML(tx, true));
        }

        function addCustomer() {
            const name = document.getElementById('new-cust-name').value;
            const type = document.getElementById('new-cust-type').value; 
            const phone = document.getElementById('new-cust-phone').value;
            if(!name) return;

            data.customers.push({ id: Date.now(), name, type, phone });
            saveData();
            document.getElementById('new-cust-name').value = '';
            renderCustomersPage();
        }

        function renderCustomersPage() {
            const list = document.getElementById('customers-list');
            list.innerHTML = '';
            
            data.customers.forEach(c => {
                const typeLabel = c.type === 'family' ? (currentLang==='fa'?'خانواده':'Family') : (currentLang==='fa'?'مشتری':'Business');
                const typeColor = c.type === 'family' ? '#9b59b6' : '#f1c40f';
                
                list.innerHTML += `
                    <div class="tx-item" onclick="openCustomerStatement(${c.id})">
                        <div style="display:flex; align-items:center;">
                            <div class="tx-icon" style="background:rgba(255,255,255,0.1); color:#fff;"><i class="fas fa-user"></i></div>
                            <div class="tx-content">
                                <h4>${c.name}</h4>
                                <p>
                                    <span class="cat-badge" style="color:${typeColor}">${typeLabel}</span>
                                    ${c.phone || ''}
                                </p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-${currentLang==='fa'?'left':'right'}" style="color:#666; font-size:12px;"></i>
                    </div>
                `;
            });
        }

        function openCustomerStatement(custId) {
    const customer = data.customers.find(c => c.id == custId);
    if(!customer) return;

    // تغییر صفحه فعال
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('statement-page').classList.add('active');
    
    // پر کردن هدر
    document.getElementById('stmt-name').innerText = customer.name;
    document.getElementById('stmt-name').style.color = 'var(--gold-primary)'; // اصلاح رنگ نام
    document.getElementById('stmt-phone').innerText = customer.phone || '---';
    const dateStr = new Date().toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US');
    document.getElementById('stmt-date').innerText = `${lang[currentLang].date}: ${dateStr}`;

    // فیلتر کردن تراکنش‌های این مشتری
    const txs = data.transactions.filter(t => t.customerId == custId).sort((a,b) => new Date(b.date) - new Date(a.date));

    // محاسبه ترازها
    const balances = {};
    txs.forEach(t => {
        if(!balances[t.currency]) balances[t.currency] = 0;
        if(t.type === 'income') balances[t.currency] += parseFloat(t.amount); 
        else balances[t.currency] -= parseFloat(t.amount); 
    });

    // نمایش خلاصه حساب (Summary) با استایل تیره
    const summaryDiv = document.getElementById('stmt-summary');
    summaryDiv.innerHTML = '';
    const hasBal = Object.keys(balances).length > 0;
    
    if(!hasBal) {
        summaryDiv.innerHTML = `<span style="color:#666; font-size:12px;">تراکنشی یافت نشد.</span>`;
    } else {
        for(const [curr, amt] of Object.entries(balances)) {
            const color = amt >= 0 ? '#2ecc71' : '#e74c3c'; // رنگ‌های روشن‌تر برای پس‌زمینه مشکی
            // اصلاح رنگ پس‌زمینه باکس‌های خلاصه
            summaryDiv.innerHTML += `
                <div style="background:rgba(255,255,255,0.05); padding:5px 15px; border:1px solid rgba(255,255,255,0.1); border-radius:6px; min-width:100px; text-align:center;">
                    <div style="font-size:11px; color:#aaa;">${curr}</div>
                    <div style="font-weight:bold; color:${color}; direction:ltr; font-size:14px;">
                        ${formatMoney(Math.abs(amt))} <span style="font-size:10px;">${amt < 0 ? '(بستانکار)' : '(بدهکار)'}</span>
                    </div>
                </div>
            `;
        }
    }

    // 1. پر کردن نمای موبایل (کارت‌ها)
    const mobileList = document.getElementById('stmt-tx-list');
    mobileList.innerHTML = '';
    txs.forEach(tx => mobileList.innerHTML += createTxHTML(tx));

    // 2. پر کردن جدول رسمی (برای پرینت)
    const tableBody = document.getElementById('stmt-table-body');
    tableBody.innerHTML = '';
    
    txs.forEach(tx => {
        const isInc = tx.type === 'income';
        const dateFormatted = new Date(tx.date).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US');
        
        const incCol = isInc ? formatMoney(tx.amount) : '-';
        const expCol = !isInc ? formatMoney(tx.amount) : '-';

        tableBody.innerHTML += `
            <tr>
                <td>${dateFormatted}</td>
                <td style="text-align: right; font-size:11px;">${tx.desc || 'بدون توضیحات'}</td>
                <td>${tx.currency}</td>
                <td class="amount-col ${isInc ? 'text-green' : ''}">${incCol}</td>
                <td class="amount-col ${!isInc ? 'text-red' : ''}">${expCol}</td>
            </tr>
        `;
    });
}
        function renderReportsPage() {
    const filterType = document.getElementById('report-filter-type').value; 
    
    let relevantTx = data.transactions.filter(t => {
        const c = data.customers.find(cu => cu.id == t.customerId);
        if(!c) return false;
        if(filterType === 'all') return true;
        return c.type === filterType; 
    });

    // تغییر منطق: گروه‌بندی فقط بر اساس ارز
    const currencyStats = {};
    relevantTx.forEach(t => {
        const key = t.currency; // کلید فقط ارز است
        if(!currencyStats[key]) currencyStats[key] = { inc: 0, exp: 0, curr: t.currency };
        
        if(t.type === 'income') currencyStats[key].inc += parseFloat(t.amount);
        else currencyStats[key].exp += parseFloat(t.amount);
    });

    const list = document.getElementById('country-report-list');
    list.innerHTML = '';
    
    // تغییر تیتر گزارش در HTML هم پیشنهاد می‌شود (دستی انجام دهید یا با جاوااسکریپت)
    document.querySelector('[data-lang="by_country"]').innerText = "تفکیک بر اساس ارز";

    if(Object.keys(currencyStats).length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:#666;">${lang[currentLang].no_data}</div>`;
    }

    for(const stats of Object.values(currencyStats)) {
        const net = stats.inc - stats.exp;
        list.innerHTML += `
            <div class="tx-item" style="display:block; cursor:default;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-weight:bold; color:var(--gold-primary); font-size:16px;">${stats.curr}</span>
                    <span style="direction:ltr; font-weight:bold; color:${net>=0?'#fff':'#e74c3c'}">تراز: ${formatMoney(net)}</span>
                </div>
                <div style="display:flex; gap:5px;">
                    <div style="flex:1; background:rgba(46,204,113,0.1); padding:5px; border-radius:5px; text-align:center;">
                        <small style="color:#aaa">${lang[currentLang].income}</small><br>
                        <span style="color:#2ecc71">${formatMoney(stats.inc)}</span>
                    </div>
                    <div style="flex:1; background:rgba(231,76,60,0.1); padding:5px; border-radius:5px; text-align:center;">
                        <small style="color:#aaa">${lang[currentLang].expense}</small><br>
                        <span style="color:#e74c3c">${formatMoney(stats.exp)}</span>
                    </div>
                </div>
            </div>
        `;
    }
}

        // --- توابع جدید پشتیبان‌گیری و تنظیمات ---

// ۱. دانلود دیتابیس به صورت فایل JSON
function downloadBackup() {
    // ایجاد نام فایل همراه با تاریخ امروز
    const date = new Date();
    const dateStr = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate();
    const fileName = `Khademe_Backup_${dateStr}.json`;

    // تبدیل داده‌ها به متن
    const dataStr = JSON.stringify(data, null, 2); // فرمت مرتب
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    // ایجاد لینک دانلود موقت و کلیک روی آن
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ۲. باز کردن پنجره انتخاب فایل
function triggerRestore() {
    document.getElementById('restore-input').click();
}

// ۳. پردازش فایل انتخاب شده و جایگزینی داده‌ها
function restoreBackup(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = JSON.parse(e.target.result);
            
            // اعتبارسنجی ساده فایل (چک می‌کنیم آیا ساختار فایل درست است)
            if (content.transactions && Array.isArray(content.transactions) && content.customers) {
                if(confirm(`آیا مطمئن هستید؟\n\nتعداد تراکنش‌های فایل: ${content.transactions.length}\n\nاطلاعات فعلی شما حذف و با این فایل جایگزین می‌شود.`)) {
                    data = content;
                    saveData(); // ذخیره در حافظه مرورگر
                    alert('اطلاعات با موفقیت بازیابی شد.');
                    location.reload(); // رفرش برای اعمال تغییرات
                }
            } else {
                alert('خطا: فایل انتخاب شده نامعتبر است یا مربوط به این برنامه نیست.');
            }
        } catch (err) {
            alert('خطا در خواندن فایل: ' + err.message);
        }
    };
    reader.readAsText(file);
    // پاک کردن مقدار اینپوت برای امکان انتخاب مجدد همان فایل
    event.target.value = '';
}

// ۴. حذف کامل و ریست
function hardReset() {
    if(confirm('هشدار جدی:\nتمامی تراکنش‌ها، مشتریان و رمز عبور حذف خواهند شد.\n\nآیا مطمئن هستید؟')) {
        localStorage.clear();
        location.reload();
    }
}
        
function editTx(id) {
    const tx = data.transactions.find(t => t.id === id);
    if (!tx) return;

    editingTxId = id; // ذخیره آیدی برای ویرایش
    currentTxType = tx.type;

    document.getElementById('modal-title').innerText = "ویرایش تراکنش";
    document.getElementById('save-tx-btn').innerText = "ذخیره تغییرات";
    
    // تبدیل تاریخ ذخیره شده به فرمت قابل نمایش در اینپوت
    const d = new Date(tx.date);
    const dateString = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    document.getElementById('tx-date').value = dateString;

    document.getElementById('tx-currency').value = tx.currency;
    document.getElementById('tx-amount').value = tx.amount;
    document.getElementById('tx-customer-select').value = tx.customerId;
    document.getElementById('tx-desc').value = tx.desc;

    document.getElementById('tx-modal').classList.remove('hidden');
}
    </script>
</body>
</html>
